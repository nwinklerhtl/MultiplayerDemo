@page "/"
@using Messages
@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager Nav

<h3 class="mb-3">Multiplayer Server Dashboard</h3>

@if (!connected)
{
    <p><em>Connecting to SignalR hub …</em></p>
}
else
{
    <div class="row">
        <div class="col-md-6">
            <h5>Packets</h5>
            <div class="border p-2 bg-dark text-light small" style="height:300px;overflow:auto;">
                @foreach (var p in packets.AsEnumerable().Reverse())
                {
                    <div>@p.Time.ToString("hh:mm:ss.fff") | <strong>@p.Src</strong> → @p.Payload.Input</div>
                }
            </div>
        </div>

        <div class="col-md-6">
            <h5>State Updates</h5>
            <div class="border p-2 bg-dark text-light small" style="height:300px;overflow:auto;">
                @foreach (var s in states.AsEnumerable().Reverse())
                {
                    <div>@s.Time.ToString("hh:mm:ss.fff") | @s.Payload.StateToString()</div>
                }
            </div>
        </div>
    </div>
    
    @* CHAOS *@
    <div class="mb-3 d-flex align-items-end gap-2">
        <div>
            <label class="form-label">Duration (s)</label>
            <input type="number" class="form-control" @bind="durationSec" min="1" max="60" />
        </div>
        <div>
            <label class="form-label">Latency (ms)</label>
            <input type="number" class="form-control" @bind="latencyMs" min="0" max="2000" />
        </div>
        <div>
            <label class="form-label">Jitter (ms)</label>
            <input type="number" class="form-control" @bind="jitterMs" min="0" max="1000" />
        </div>
        <div>
            <label class="form-label">Loss (0..1)</label>
            <input type="number" step="0.05" class="form-control" @bind="loss" min="0" max="1" />
        </div>

        <button class="btn btn-danger" @onclick="TriggerPanic" disabled="@(hub is null || !connected)">Panic</button>

        <div class="ms-auto">
            <span class="badge @(chaos?.Active == true ? "bg-danger" : "bg-success")">
                @(chaos?.Active == true ? $"PANIC {Math.Max(0, chaos.RemainingMs/1000)}s" : "Normal")
            </span>
            @if (chaos is not null)
            {
                <small class="text-muted ms-2">
                    L=@chaos.LatencyMs ms, J=@chaos.JitterMs ms, Loss=@chaos.Loss
                </small>
            }
        </div>
    </div>
    
    @* Game Visualization *@
    <div class="mt-4">
        <!-- Outer container: black background + fixed aspect ratio 4:3 -->
        <div class="server-view">
            <!-- SVG scales to container, keeps aspect ratio, and uses an 800x600 virtual space -->
            <svg viewBox="0 0 800 600" preserveAspectRatio="xMidYMid meet" class="server-svg">
                <!-- BACKGROUND (dark) -->
                <rect x="0" y="0" width="800" height="600" fill="#000000" />

                @if (latestState is not null)
                {
                    <!-- ORBS (simple cyan circles) -->
                    @foreach (var o in latestState.Orbs)
                    {
                        <circle cx="@o.X" cy="@o.Y" r="6" fill="#78FFF0" />
                    }

                    <!-- PLAYERS (triangles pointing right by default, rotated by Angle) -->
                    @foreach (var p in latestState.Players)
                    {
                        var a = RadToDeg(p.Angle); // 0 rad means "right" in our world; triangle points right by default

                        <!-- Triangle defined in LOCAL coords, pointing right: (nose) (tail-top) (tail-bottom) -->
                        <circle cx="@p.X" cy="@p.Y" r="6" fill="red" />

                        <!-- Name/score label (tiny, above) -->
                        <svg:text x="@(p.X + 14)" y="@(p.Y - 10)" font-size="10" fill="#CCCCCC">
                            @p.Id (@p.Score)
                        </svg:text>
                    }
                }
            </svg>
        </div>
    </div>
    
    
}

@code {
    // infrastructure
    private HubConnection? hub;
    private bool connected;
    
    // state
    private record State(StateMessage Payload, DateTime Time);
    private readonly List<SignalRPacketMessage> packets = new();
    private readonly List<State> states = new();
    
    // for game field rendering
    private StateMessage? latestState;
    
    // for chaos
    private int durationSec = 10;
    private int latencyMs = 120;
    private int jitterMs = 40;
    private double loss = 0.30;
    private ChaosDto? chaos;

    protected override async Task OnInitializedAsync()
    {
        hub = new HubConnectionBuilder()
            .WithUrl("http://192.168.0.7:5137/networkHub")
            .WithAutomaticReconnect()
            .Build();

        hub.On<SignalRPacketMessage>("PacketEvent", data =>
        {
            packets.Add(data);
            if (packets.Count > 20) packets.RemoveAt(0);
            InvokeAsync(StateHasChanged);
        });

        hub.On<SignalRStateMessage>("StateUpdate", data =>
        {
            states.Add(new State(data.Payload, data.Time));
            while (states.Count > 20) states.RemoveAt(0);
            latestState = data.Payload;
            InvokeAsync(StateHasChanged);
        });
        
        // listen to chaos status broadcasts
        hub.On<ChaosDto>("ChaosStatus", dto =>
        {
            chaos = dto;
            InvokeAsync(StateHasChanged);
        });

        await hub.StartAsync();
        connected = true;
        
        // query initial status
        chaos = await hub.InvokeAsync<ChaosDto>("GetChaosStatus");
        StateHasChanged();
    }
    
    private async Task TriggerPanic()
    {
        if (hub is null) return;
        await hub.InvokeAsync("Panic", durationSec, latencyMs, jitterMs, loss);
        // server will broadcast ChaosStatus; we also fetch it defensively:
        chaos = await hub.InvokeAsync<ChaosDto>("GetChaosStatus");
        StateHasChanged();
    }

    // Helper for SVG rotation (radians -> degrees)
    private static double RadToDeg(float rad) => rad * (180.0 / Math.PI);
}
